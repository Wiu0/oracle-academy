import java.sql.SQLException;
import java.util.HashMap;
import java.util.Map;

import br.com.maxicode.core.Conexao;
import br.com.maxicode.db.IRecordSet;
import br.com.visualmix.generico.conexao.Application;

public class NoPrideButItWorks {

	public static Map<String, String> tokenNo;
	static Conexao con;
	static Sender s = new Sender();
	
	static {
		Application.ArquivoConf = "vm-presale.conf";
		Application.initialize();
		con = Application.getInstance().getConexaoPrincipal();
		tokenNo = new HashMap<String, String>();
	}
		
	static Conexao conPush = new Conexao();
	
	public static void main(String[] args) throws ClassNotFoundException, SQLException, InterruptedException {
		
		conPush.setTipoConexao(con.getTipoConexao());
		conPush.setBanco("vm_push");
		conPush.setServidor(con.getServidor());
		conPush.setLogin(con.getLogin());
		conPush.setSenha(con.getSenha());
		conPush.setPorta(con.getPorta());
		conPush.openConexao();
		
		IRecordSet rst = conPush.getRecordSet("SELECT * FROM USER_GROUP");
		
		while(rst.next()) {
			tokenNo.put(rst.getString("key"), rst.getString("token_fcm"));
		}
		rst.close();
		
		while(true) {
			System.out.println("doing AVAILABLE_PICK");
			doAlterStatus("AVAILABLE_PICK", 10000, "DELIVERING");
			System.out.println("doing DELIVERING");
			doAlterStatus("DELIVERING", 20000, "FINISHED");
			
		}
	}
	
	private static void doAlterStatus(String sql, long timeWait, String st) throws InterruptedException {
		String where = " WHERE STATUS = " + con.toString(sql);
		IRecordSet rst = con.getRecordSet(
				"SELECT COMPANY_ID, ID_IDENTIFIER_FK, ID_SHOPPING_CART FROM SHOPPING_CART" + where);
		while(rst.next()) {
			s.send(rst.getInt("company_id"), rst.getLong("ID_SHOPPING_CART"),rst.getInt("ID_IDENTIFIER_FK"), st);
		}
		rst.close();
		con.executeSQL("UPDATE SHOPPING_CART set STATUS = " + con.toString(st) + where);
		Thread.sleep(timeWait);
	}

	@Override
	protected void finalize() throws Throwable {
		try {
			Application.getInstance().close();
		}catch (Exception e) {
		
		}
		try {
			Application.getInstance().closeConexao(conPush);
		}catch (Exception e) {
		}
	}

}
